---
layout: default
---

<div class="strava-stats">
  <h1>{{ page.title }}</h1>
  {{ content }}

  <!-- Add in a refresh data button that calls /strava/sync -->
  <button onclick="refreshData()">Refresh Data</button>
  
  <div class="chart-container">
    <a href="/weekly_chart.html?start_date=2025-01-01"> <h2>Weekly Running Distance</h2>
    </a>
    <div id="weekly-running-chart"></div>
  </div>

  <div class="chart-container">
    <a href="/cumulative_chart.html?target=1000&start_date=2025-01-01">
      <h2>Cumulative Running Distance</h2>
    </a>
    <div id="cumulative-mileage-data"></div>
    <div id="cumulative-mileage-chart"></div>
  </div>

  <script src="https://cdn.plot.ly/plotly-2.35.3.min.js"></script>
  <script>
    if (typeof Plotly === 'undefined') {
      console.error('Plotly is not loaded');
    }
    async function refreshData() {
      const response = await fetch('/strava/sync');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      console.log('Data refreshed');
    }

    // Function to fetch and display a chart
    async function displayChart(endpoint, containerId) {
      try {
        console.log(`Fetching data from ${endpoint}`);
        const response = await fetch(endpoint);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parse the JSON response
        const plotData = await response.json();
        console.log('Received plot data:', plotData);
        
        if (!plotData.data || !plotData.layout) {
          throw new Error('Invalid plot data received');
        }
        
        // Create the plot
        await Plotly.newPlot(containerId, plotData.data, plotData.layout);
        console.log(`Successfully rendered plot for ${endpoint}`);
      } catch (error) {
        console.error(`Error fetching ${endpoint}:`, error);
        document.getElementById(containerId).innerHTML = 
          `<p class="error">Failed to load data. Please try again later.</p>`;
      }
    }
    async function displayCumulativeMiles(containerId) {
      try {
        const response = await fetch('/running/cumulative_mileage?target=1000');
        const plotData = await response.json();
        max_day_run = plotData['data'][0]['x'].slice(-1)
        total_days_run = plotData['data'][0]['x'].length
        max_mileage = plotData['data'][0]['y'].slice(-1)
        max_days_target = plotData['data'][1]['x'].slice(-1)
        max_miles_target = plotData['data'][1]['y'].slice(-1)
        max_days_target_percent = max_day_run / max_days_target
        avg_miles_run = max_mileage / total_days_run
        max_miles_target_percent = max_mileage / max_miles_target
        miles_remaining = max_miles_target - max_mileage
        miles_remaining_percent = (miles_remaining / max_miles_target) * 100
        days_remaining = max_days_target - max_day_run
        days_remaining_percent = (days_remaining / max_days_target) * 100
        miles_per_day_remaining = miles_remaining / days_remaining
        miles_per_day_remaining_rounded = miles_per_day_remaining.toFixed(2)
        miles_per_week_remaining = (miles_per_day_remaining * 7).toFixed(2)
        miles_remaining_percent_rounded = ((1-miles_remaining_percent)*100).toFixed(2)
        max_days_target_percent_rounded = (max_days_target_percent*100).toFixed(2)
        max_miles_target_percent_rounded = (max_miles_target_percent*100).toFixed(2)
        days_remaining_percent_rounded = (days_remaining_percent*100).toFixed(2)
        document.getElementById(containerId).innerHTML = `
          <p>Days run: ${total_days_run}/${max_days_target} (${Math.round(total_days_run/max_days_target*100)}%)</p>
          <p>Latest mileage: ${Math.round(max_mileage, 1)}/${max_miles_target} (${Math.round(max_mileage/max_miles_target*100)}%)</p>
          <p>Average miles per run: ${avg_miles_run.toFixed(2)}</p>
          <p>Miles remaining: ${miles_remaining.toFixed(2)}</p>
          <p>Days remaining: ${days_remaining}</p>
          <p>Miles per day remaining to target: ${miles_per_day_remaining_rounded}</p>
          <p>Miles per week remaining to target: ${miles_per_week_remaining}</p>
          <p>On pace to run ${Math.round((max_mileage*max_days_target)/max_day_run, 1)} miles in ${max_days_target} days</p>
        `;
      } catch (error) {
        console.error(`Error fetching cumulative mileage data:`, error);
      }
    }

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch and display both charts
      displayChart('/running/weekly_running_chart', 'weekly-running-chart');
      displayChart('/running/cumulative_mileage?target=1000', 'cumulative-mileage-chart');
      displayCumulativeMiles('cumulative-mileage-data');
    });
  </script>
</div>

<style>
.strava-stats {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.chart-container {
  margin: 40px 0;
}

.chart-container h2 {
  margin-bottom: 20px;
  color: #FC4C02;  /* Strava orange */
}

#weekly-running-chart,
#cumulative-mileage-chart {
  width: 100%;
  height: 600px;
  margin: 20px 0;
}

.error {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  padding: 15px;
  border-radius: 4px;
  margin: 10px 0;
}
</style>